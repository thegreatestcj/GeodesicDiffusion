# Flux BVP Configuration with Semantic Regularization
# Adapted for Flux.1-dev architecture

# Gradient computation settings
grad_args:
  grad_sample_range: 100       # Timestep sampling range
  grad_weight_type: 'uniform'  # Weight scheme: uniform, increase, decrease
  grad_guidance_0: 1.0         # Positive prompt weight
  grad_guidance_1: 1.0         # Negative prompt weight
  grad_sample_type: 'back_n_forward_sample'
  grad_batch_size: 1           # Batch size 1 for memory efficiency on 24GB GPU

# Output settings
output_args:
  cfg_sample: 3.5              # CFG scale (Flux default is 3.5)
  num_inference_steps: 8       # Flux needs fewer steps
  out_dir: 'results_flux/'
  output_psample: True         # Perceptually uniform sampling
  output_image_num: 9         # Number of output frames
  output_start_images: False
  output_opt_points: True
  output_reconstruct_end: True
  output_separate_images: True
  out_interval: -1             # -1 = only save final

# Bisection sampler settings
bisect_args:
  max_strength: 4
  bisect_interval: 20          # Lowered from 100 for faster convergence
  random_end: False
  only_new_points: False

# Optimizer settings
opt_args:
  lr: 0.05                     # Lower LR for Flux (more sensitive)
  iter_num: 40                # Lowered from 200 for faster runs
  lr_scheduler: 'linear'
  lr_divide: True

# Text inversion settings
# NOTE: Set tv_steps: 0 to skip text inversion (saves memory on 24GB GPUs)
# Text inversion with Flux requires disabling CPU offload and ~40GB VRAM
tv_args:
  tv_lr: 0.003                 # Lower LR for Flux
  tv_steps: 0                  # Set to 0 to skip (memory-saving), or 300 for optimization
  tv_batch_size: 1             # Smaller batch for memory
  tv_ckpt_folder: 'tv_ckpt_flux/'

# Geodesic parameters
noise_level: 0.6               # Noise level [0, 1]
use_lerp_cond: True            # Interpolate text embeddings
alpha: 0.002                   # Geodesic smoothness weight
sphere_constraint: True        # Constrain path to sphere
grad_analysis_out: True

# ===========================================
# Semantic Regularization (NEW)
# ===========================================
# NOTE: Disabled for 24GB GPUs - DINO model + VAE decoding adds ~3-4GB overhead
# Enable only if you have 32GB+ VRAM or are using smaller images
semantic_args:
  use_semantic_reg: False      # Disabled for memory - enable on 32GB+ GPUs
  semantic_weight: 0.1         # Weight for semantic consistency term
  dino_model: 'dinov2_vits14'  # DINO model: dinov2_vits14, dinov2_vitb14, dinov2_vitl14

# Test configuration
test_name: 'ld1'
promptA: ''
promptB: ''
pathA: 'assets/art1-1.jpg'
pathB: 'assets/art1-2.jpg'

# Flux-specific settings
flux_args:
  model_id: 'black-forest-labs/FLUX.1-dev'
  dtype: 'bfloat16'
  enable_cpu_offload: True     # Essential for 24GB VRAM
  disable_text_encoder: True   # Disable text encoders to save ~10GB VRAM (uses null embeddings)